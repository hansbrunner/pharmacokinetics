---
title: "Exploratory Non-Compartmental Pharmacokinetic Analysis of Single Ascending Dose (SAD) Experiments"
author: "Hans Brunner"
date: "2024-11-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This report presents an exploratory pharmacokinetic (PK) analysis of single ascending dose (SAD) experiments, focusing on key non-compartmental (NC) metrics - AUC and Cmax. The analysis aims to characterize the concentration-time profile of the drug across different doses, using simulated data from https://opensource.nibr.com/xgx/Single_Ascending_Dose_PK.html

```{r load libraries and data, error = TRUE, warning=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(xgxr)
library(readr)
library(caTools)
library(patchwork)

pkpd_data <- read_csv('../data/Single_Ascending_Dose_Dataset2.csv')

pkpd_data = pkpd_data %>%
  arrange(DOSE) %>%
  mutate(TRTACT_low2high = factor(TRTACT, levels = unique(TRTACT)),
         TRTACT_high2low = factor(TRTACT, levels = rev(unique(TRTACT)))) %>%
  select(-TRTACT)

pk_data <- pkpd_data %>%
  filter(CMT==2)

#perform NCA, for additional plots
NCA = pk_data %>%
  group_by(ID, DOSE) %>% # groupby id and dose
  filter(!is.na(LIDV)) %>% # only valid LIDV values
  summarize(AUC_last = caTools::trapz(TIME,LIDV),
            Cmax     = max(LIDV),
            SEX      = SEX[1], #this part just keeps the SEX and WEIGHTB covariates
            WEIGHTB  = WEIGHTB[1]) %>%
  gather(PARAM, VALUE,-c(ID, DOSE, SEX, WEIGHTB)) %>%
  ungroup() %>%
  mutate(VALUE_NORM = VALUE/DOSE)

#units and labels for plots
time_units_dataset = "hours"
time_units_plot    = "days"
trtact_label       = "Dose"
dose_label         = "Dose (mg)"
conc_units         = "ng/ml"
AUC_units          = paste0("h.", conc_units)
conc_label         = paste0("Concentration (", conc_units, ")") 
concnorm_label     = paste0("Normalized Concentration (", conc_units, ")/mg")
```

## Plots

Concentration time curves for different doses

```{r plot concentration time curves, error = TRUE, warning=FALSE, message=FALSE}
ct_plot <- ggplot(data = pk_data, 
                  aes(x = NOMTIME, y = LIDV, 
                      group = TRTACT_high2low, 
                      color = TRTACT_high2low))
ct_plot <- ct_plot + xgx_stat_ci(conf_level = .95)
ct_plot <- ct_plot + xgx_scale_x_time_units(units_dataset = time_units_dataset, 
                                  units_plot    = time_units_plot)
ct_plot <- ct_plot + labs(y=conc_label,color = trtact_label)

# Make semilog plot
ct_plot_log <- ct_plot +
  scale_y_log10() +
  theme(legend.position = "none") +
  labs(y = paste0(conc_label, " (Log Scale)"))

combined_plot <- ct_plot + ct_plot_log + plot_layout(ncol = 2)


print(combined_plot)
```

Normalized concentration by dose
```{r plot dose normalized concentration time curves, error = TRUE, warning=FALSE, message=FALSE}
pk_data <- pk_data %>%
            mutate(LIDV_NORM = LIDV/DOSE)
ct_plot_norm <- ggplot(data = pk_data, 
                       aes(x = NOMTIME, y = LIDV_NORM, 
                          group = TRTACT_high2low, 
                          color = TRTACT_high2low))

ct_plot_norm <- ct_plot_norm + xgx_stat_ci(conf_level = 0.95, alpha = 0.5, position = position_dodge(1))
ct_plot_norm <- ct_plot_norm + xgx_scale_y_log10()
ct_plot_norm <- ct_plot_norm + xgx_scale_x_time_units(units_dataset = time_units_dataset, 
                                  units_plot    = time_units_plot)
ct_plot_norm <- ct_plot_norm + labs(y=concnorm_label, color = trtact_label)

# Make semilog plot
ct_plot_log <- ct_plot_norm +
  scale_y_log10() +
  theme(legend.position = "none") +
  labs(y = paste0(conc_label, " (Log Scale)"))

combined_plot <- ct_plot_norm + ct_plot_log + plot_layout(ncol = 2)


print(combined_plot)
```

Dose Normalized AUC and Cmax from NCA 

```{r Plot dose normalized AUC and Cmax, error = TRUE, warning=FALSE, message=FALSE}
gg <- ggplot(data = NCA, aes(x = DOSE, y = VALUE_NORM))
gg <- gg + geom_boxplot(aes(group = DOSE)) 
gg <- gg + geom_smooth(method = "lm", color = "black")
gg <- gg + facet_wrap(~PARAM, scales = "free_y") 
gg <- gg + labs(x = dose_label, y = concnorm_label)

print(gg)
```

Stratify covariates (gender and bodyweight)

```{r Stratify covariates, error = TRUE, warning=FALSE, message=FALSE}
auc_data <- NCA %>% filter(PARAM == "AUC_last")
cmax_data <- NCA %>% filter(PARAM == "Cmax")

# AUC Men vs Women
boxplot_auc <- ggplot(auc_data, aes(x = SEX, y = VALUE_NORM, fill = SEX)) +
  geom_boxplot() +
  labs(title = "Dose-normalized AUC by Sex", y = "AUC_norm", x = "Sex") +
  theme_minimal()

# Cmax Men vs Women
boxplot_cmax <- ggplot(cmax_data, aes(x = SEX, y = VALUE_NORM, fill = SEX)) +
  geom_boxplot() +
  labs(title = "Dose-normalized Cmax by Sex", y = "Cmax_norm", x = "Sex") +
  theme_minimal()

# AUC vs bodyweight
scatter_auc <- ggplot(auc_data, aes(x = WEIGHTB, y = VALUE_NORM)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "AUC_norm vs Body Weight", x = "Body Weight", y = "AUC_norm") +
  theme_minimal()

# Cmax vs bodyweigh
scatter_cmax <- ggplot(cmax_data, aes(x = WEIGHTB, y = VALUE_NORM)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Cmax_norm vs Body Weight", x = "Body Weight", y = "Cmax_norm") +
  theme_minimal()

combined_plot <- (boxplot_auc | boxplot_cmax) / (scatter_auc | scatter_cmax)

print(combined_plot)
```


 